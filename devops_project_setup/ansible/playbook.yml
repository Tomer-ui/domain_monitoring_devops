---
# ==========================================
# PLAY 1: COMMON CONFIGURATION
# ==========================================
- name: Configure Common Dependencies
  hosts: all
  become: yes
  tasks:
    # 1. SWAP CONFIGURATION (Essential for stability)
    - name: Create and Enable Swap (2GB)
      shell: |
        swapoff /swapfile || true
        dd if=/dev/zero of=/swapfile bs=128M count=16
        chmod 0600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        grep -q '/swapfile' /etc/fstab || echo '/swapfile none swap sw 0 0' >> /etc/fstab
      register: swap_result

    # 2. DOCKER INSTALLATION
    - name: Update Apt Cache
      apt:
        update_cache: yes

    - name: Install Prerequisite Packages
      apt:
        name: [apt-transport-https, ca-certificates, curl, software-properties-common, python3-pip, unzip, openjdk-17-jre]
        state: present

    - name: Add Docker GPG Key and Repo
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"

    - name: Install Docker & Python SDK
      apt:
        name: docker-ce
        state: present
    
    - name: Install Python Docker Library
      pip:
        name: docker
        extra_args: "--break-system-packages"

    - name: Add ubuntu to docker group
      user: { name: ubuntu, groups: docker, append: yes }

# ==========================================
# PLAY 2: MASTER SETUP
# ==========================================
- name: Configure Jenkins Master
  hosts: master
  become: yes
  vars_files: [secrets.yml]
  
  tasks:
    - name: Create Config Dirs
      file: { path: /var/jenkins_home/casc_configs, state: directory, mode: '0777' }

    - name: Copy JCasC File
      copy:
        src: ./jcasc_configs/jenkins.yaml
        dest: /var/jenkins_home/casc_configs/jenkins.yaml

    # 1. Start Jenkins (Initial Boot)
    - name: Start Jenkins Master
      docker_container:
        name: jenkins-master
        image: jenkins/jenkins:lts-jdk17
        state: started
        restart_policy: always
        ports: ["8080:8080", "50000:50000"]
        volumes:
          - /var/jenkins_home/casc_configs:/var/jenkins_home/casc_configs
          - jenkins_data:/var/jenkins_home
        env:
          CASC_JENKINS_CONFIG: /var/jenkins_home/casc_configs/jenkins.yaml
          JAVA_OPTS: "-Xmx384m -Djenkins.install.runSetupWizard=false"
          JENKINS_ADMIN_PASSWORD: "{{ my_jenkins_pass }}"

    # 2. Install Plugins
    - name: Install Jenkins Plugins
      shell: |
        docker exec -u root jenkins-master \
        jenkins-plugin-cli --plugins configuration-as-code git job-dsl workflow-aggregator pipeline-stage-view docker-plugin docker-workflow
      register: plugin_result
      changed_when: "'Downloaded' in plugin_result.stdout"

    # 3. Fix Permissions & Restart
    - name: Fix Jenkins Home Permissions
      shell: docker exec -u root jenkins-master chown -R 1000:1000 /var/jenkins_home

    - name: Restart Jenkins to apply plugins
      docker_container:
        name: jenkins-master
        state: started
        restart: yes

    # 4. Optimized Waits
    - name: Wait for Port 8080
      wait_for:
        port: 8080
        delay: 2
        timeout: 60

    - name: Wait for Jenkins to be ready
      uri:
        url: "http://localhost:8080/login"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 40   # Max 2 minutes
      delay: 3      # Check every 3 seconds

    # 5. Get Secret (Cookie Jar Method)
    - name: Get Jenkins Node Secret
      shell: |
        CRUMB=$(curl -s 'http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)' -u "admin:{{ my_jenkins_pass }}" -c /tmp/cookies)
        
        curl -s -X POST 'http://localhost:8080/scriptText' \
             -u "admin:{{ my_jenkins_pass }}" \
             -b /tmp/cookies \
             -H "$CRUMB" \
             --data-urlencode "script=println(jenkins.model.Jenkins.instance.getNode('jenkins-node-1')?.computer?.jnlpMac)"
      register: secret_output
      until: secret_output.stdout != "null" and secret_output.stdout != ""
      retries: 20
      delay: 3

    - name: Print Secret
      debug:
        msg: "The secret is {{ secret_output.stdout }}"

# ==========================================
# PLAY 3: NODE SETUP
# ==========================================
- name: Configure Jenkins Node
  hosts: node
  become: yes
  vars:
    master_private_ip: "{{ hostvars[groups['master'][0]]['private_ip'] }}"
    node_secret: "{{ hostvars[groups['master'][0]]['secret_output']['stdout'] }}"
  
  tasks:
    - name: Ensure Workspace Directory Exists
      file:
        path: /home/jenkins
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    - name: Start Agent Container
      docker_container:
        name: jenkins-agent
        image: jenkins/inbound-agent:latest
        state: started
        restart_policy: always
        volumes: 
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "/home/jenkins:/home/jenkins"
        user: root 
        env:
          JENKINS_URL: "http://{{ master_private_ip }}:8080"
          JENKINS_AGENT_NAME: "jenkins-node-1"
          JENKINS_SECRET: "{{ node_secret }}"
          JENKINS_WORKDIR: "/home/jenkins"