---
# PLAY 1: COMMON CONFIG
- name: Configure Common Dependencies
  hosts: all
  become: yes
  tasks:
    - name: Create Swap (4GB)
      shell: |
        if [ ! -f /swapfile ]; then
          dd if=/dev/zero of=/swapfile bs=128M count=32
          mkswap /swapfile
          chmod 0600 /swapfile
          swapon /swapfile
        fi

    - name: Install Docker
      shell: |
        apt-get update
        apt-get install -y apt-transport-https ca-certificates curl software-properties-common python3-pip
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
        apt-get install -y docker-ce

    - name: Install Python Docker SDK
      pip:
        name: docker
        extra_args: "--break-system-packages"

    - name: Add ubuntu to docker group
      user: { name: ubuntu, groups: docker, append: yes }

# PLAY 2: MASTER SETUP
- name: Configure Jenkins Master
  hosts: master
  become: yes
  vars_files: [secrets.yml]
  
  tasks:
    - name: Create Config Dirs
      file: { path: /var/jenkins_home/casc_configs, state: directory, mode: '0777' }

    - name: Copy JCasC File
      copy:
        src: ./jcasc_configs/jenkins.yaml
        dest: /var/jenkins_home/casc_configs/jenkins.yaml

    # FIX: Create plugins list manually to avoid line-ending issues
    - name: Create Plugins List
      copy:
        dest: /var/jenkins_home/plugins.txt
        mode: '0666'
        content: |
          configuration-as-code
          git
          job-dsl
          workflow-aggregator
          pipeline-stage-view
          docker-plugin
          docker-workflow
          instance-identity

    # FIX: Install Plugins using a temporary container (Saves RAM)
    - name: Install Plugins (Offline Mode)
      docker_container:
        name: plugin-installer
        image: jenkins/jenkins:lts-jdk17
        state: started
        user: root 
        entrypoint: ["jenkins-plugin-cli", "-f", "/var/jenkins_home/plugins.txt", "-d", "/var/jenkins_home/plugins", "--verbose"]
        volumes:
          - /var/jenkins_home/plugins.txt:/var/jenkins_home/plugins.txt
          - jenkins_data:/var/jenkins_home
        detach: false
        cleanup: yes

    # START JENKINS (With Memory Limit)
    - name: Start Jenkins Master
      docker_container:
        name: jenkins-master
        image: jenkins/jenkins:lts-jdk17
        state: started
        restart_policy: always
        ports: ["8080:8080", "50000:50000"]
        volumes:
          - /var/jenkins_home/casc_configs:/var/jenkins_home/casc_configs
          - jenkins_data:/var/jenkins_home
        env:
          CASC_JENKINS_CONFIG: /var/jenkins_home/casc_configs/jenkins.yaml
          JAVA_OPTS: "-Xmx512m -Djenkins.install.runSetupWizard=false"
          JENKINS_ADMIN_PASSWORD: "{{ my_jenkins_pass }}"

    # WAIT LOGIC
    - name: Wait for Jenkins Node to be Ready
      uri:
        url: "http://localhost:8080/computer/jenkins-node-1/api/json"
        user: "admin"
        password: "{{ my_jenkins_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: node_check
      until: node_check.status == 200
      retries: 60
      delay: 10

    # SECRET PARSING
    - name: Fetch Secret
      shell: |
        curl -L -s -u admin:{{ my_jenkins_pass }} "http://localhost:8080/computer/jenkins-node-1/jenkins-agent.jnlp" | \
        grep -o '<argument>[^<]*</argument>' | head -n 1 | cut -d '>' -f 2 | cut -d '<' -f 1
      register: secret_output

# PLAY 3: NODE SETUP
- name: Configure Jenkins Node
  hosts: node
  become: yes
  vars:
    master_ip: "{{ groups['master'][0] }}"
    node_secret: "{{ hostvars[groups['master'][0]]['secret_output']['stdout'] }}"
  
  tasks:
    - name: Start Agent
      docker_container:
        name: jenkins-agent
        image: jenkins/inbound-agent:latest
        state: started
        restart_policy: always
        volumes: ["/var/run/docker.sock:/var/run/docker.sock"]
        env:
          JENKINS_URL: "http://{{ master_ip }}:8080"
          JENKINS_AGENT_NAME: "jenkins-node-1"
          JENKINS_SECRET: "{{ node_secret }}"
          JENKINS_WORKDIR: "/home/jenkins"